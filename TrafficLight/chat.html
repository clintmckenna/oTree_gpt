{% extends "global/Page.html" %}
{% block title %}Traffic Light Game{% endblock %}

{% block styles %}
<style>
    .otree-timer {
        display: none !important;
    }

    .card.debug-info {
        display: none !important;
    }

    body {
        background-color: #000;
        color: #fff;
        font-family: 'Roboto', sans-serif;
        text-align: center;
    }

    .game-container {
        position: relative;
        width: 600px;
        height: 500px;
        margin: 20px auto;
        border: 2px solid #333;
        background-color: #111;
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        padding-bottom: 20px;
    }

    .header {
        margin-top: 20px;
        font-size: 24px;
    }

    .track {
        position: relative;
        width: 2px;
        height: 400px;
        background-color: #555;
    }

    .finish-line {
        position: absolute;
        top: 50px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #fff;
        z-index: 1;
    }

    .traffic-light {
        width: 60px;
        height: 120px;
        background-color: #333;
        border-radius: 10px;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        padding: 5px;
        border: 2px solid #555;
        z-index: 10;
    }

    .light {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        opacity: 0.3;
        transition: opacity 0.3s;
    }

    .light.red {
        background-color: #ff0000;
    }

    .light.green {
        background-color: #00ff00;
    }

    .light.active {
        opacity: 1;
        box-shadow: 0 0 15px currentColor;
    }

    .player-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        position: absolute;
        left: -14px;
        /* Center on track */
        bottom: 0;
        transition: bottom 0.2s linear;
        border: 2px solid #fff;
    }

    .player-me {
        background-color: #3498db;
        z-index: 5;
    }

    .player-bot1 {
        background-color: #e74c3c;
        z-index: 4;
    }

    .player-bot2 {
        background-color: #2ecc71;
        z-index: 4;
    }

    .controls {
        margin-top: 20px;
    }

    button#move-btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    button#move-btn:hover {
        background-color: #2980b9;
    }

    button#move-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}

<div class="header">
    Round <span id="round-num"></span> of <span id="total-rounds"></span>
    <br>
    Your endowment: <span id="endowment">20</span>
</div>

<div class="game-container">
    <!-- Finish Line Visual (Horizontal line across container) -->
    <div style="position: absolute; top: 100px; width: 100%; height: 2px; background: #fff; opacity: 0.5;"></div>
    <div style="position: absolute; top: 100px; right: 10px; color: #fff; font-size: 12px;">FINISH</div>

    <!-- Sign -->
    {% if show_sign %}
    <div
        style="position: absolute; top: 20px; left: 10px; color: #f1c40f; font-size: 14px; width: 150px; text-align: left; border: 1px solid #f1c40f; padding: 5px;">
        {{ sign_text }}
    </div>
    {% endif %}

    <!-- Caught Alert (Hidden by default) -->
    <div id="caught-alert"
        style="display:none; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 48px; font-weight: bold; border: 4px solid red; padding: 20px; background: rgba(0,0,0,0.8); z-index: 100;">
        CAUGHT!
    </div>

    <!-- Traffic Light -->
    <div class="traffic-light">
        <div id="light-red" class="light red active"></div>
        <div id="light-green" class="light green"></div>
    </div>

    <!-- Tracks and Players -->
    <div class="track" id="track-bot1">
        <div class="player-dot player-bot1" id="dot-bot1" title="Bot 1 (Red)"></div>
        <div style="position:absolute; bottom:-30px; left:-20px; width:50px; font-size:12px;">Bot 1</div>
    </div>

    <div class="track" id="track-me">
        <div class="player-dot player-me" id="dot-player" title="You (Blue)"></div>
        <div style="position:absolute; bottom:-30px; left:-20px; width:50px; font-size:12px;">You</div>
    </div>

    <div class="track" id="track-bot2">
        <div class="player-dot player-bot2" id="dot-bot2" title="Bot 2 (Green)"></div>
        <div style="position:absolute; bottom:-30px; left:-20px; width:50px; font-size:12px;">Bot 2</div>
    </div>
</div>

<div class="controls">
    <button type="button" id="move-btn" onclick="sendMove()">Move (Push to Cross)</button>
    <button id="next-btn" class="otree-btn-next btn btn-primary" style="display:none;">Next Round</button>
</div>

<script>
    // Game State
    let greenTime = 0; // Will be set by server
    let endowment = 20;
    let timerInterval = null;
    let greenTimeout = null;
    let isFinished = false;
    let bot1Wait = js_vars.bot1_wait;
    let bot2Wait = js_vars.bot2_wait;

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById('round-num').innerText = js_vars.round_number;
        document.getElementById('total-rounds').innerText = js_vars.total_rounds || '5';

        // Ensure Light is RED initially
        updateLight('RED');

        liveSend({ 'type': 'load' });
    });

    function startGame(serverGreenTime) {
        greenTime = serverGreenTime;

        // Start Endowment Countdown
        timerInterval = setInterval(() => {
            if (endowment > 0) {
                endowment--;
                document.getElementById('endowment').innerText = endowment;
            }
        }, 1000);

        // Set Timeout for Green Light
        greenTimeout = setTimeout(() => {
            if (!isFinished) {
                triggerGreen();
            }
        }, greenTime * 1000);

        // Bot Animations
        setTimeout(() => {
            document.getElementById('dot-bot1').style.bottom = '350px';
        }, bot1Wait * 1000);

        setTimeout(() => {
            document.getElementById('dot-bot2').style.bottom = '350px';
        }, bot2Wait * 1000);
    }

    function triggerGreen() {
        if (isFinished) return;
        isFinished = true;

        // Clear Timer
        clearInterval(timerInterval);

        // Update Visuals
        updateLight('GREEN');

        // Move "Me" dot to finish line instantly for visual effect
        document.getElementById('dot-player').style.bottom = '350px';
        document.getElementById('dot-bot1').style.bottom = '350px';
        document.getElementById('dot-bot2').style.bottom = '350px';

        // Send Finish to Server
        liveSend({ 'type': 'finish', 'reason': 'green' });
    }

    function sendMove() {
        if (isFinished) return;
        isFinished = true;

        // Clear Timer
        clearInterval(timerInterval);
        clearTimeout(greenTimeout);

        // Move "Me" dot instantly
        document.getElementById('dot-player').style.bottom = '350px';

        // Send Finish to Server
        liveSend({ 'type': 'finish', 'reason': 'moved' });
    }

    function liveRecv(data) {
        if (data.type === 'init') {
            endowment = data.endowment;
            document.getElementById('endowment').innerText = endowment;

            // Start local game logic with server-provided time
            startGame(data.green_time);
        }

        if (data.type === 'finished') {
            // Server acknowledged finish
            document.getElementById('move-btn').disabled = true;
            document.getElementById('endowment').innerText = data.payoff;

            if (data.caught) {
                document.getElementById('caught-alert').style.display = 'block';
                document.getElementById('move-btn').innerText = "PENALTY! Score: " + data.payoff;
            } else {
                document.getElementById('move-btn').innerText = "Round Ends. Final Endowment: " + data.payoff;
            }

            // Auto submit after short delay or show button?
            // User said "round ends". Let's show Next button or auto submit.
            // Let's auto-submit for smoother flow as per "round ends" description usually implying transition.
            setTimeout(() => {
                document.getElementById('form').submit();
            }, 2000);
        }
    }

    function updateLight(color) {
        const redLight = document.getElementById('light-red');
        const greenLight = document.getElementById('light-green');

        if (color === 'RED') {
            redLight.classList.add('active');
            greenLight.classList.remove('active');
        } else {
            redLight.classList.remove('active');
            greenLight.classList.add('active');
        }
    }
</script>


{% endblock %}