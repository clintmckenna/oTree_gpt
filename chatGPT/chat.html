{{ extends "chatGPT/Page.html" }}

{{ block title }}
{{ endblock }}

{{ block scripts }}

    <script>
        // list of chat messages as JSON dictionaries
        var chatLogData = [];
    
        // timestamp of page loading to determine when messages were sent
        var timeBase = Date.now();
    
        // adapting chat from oTree snippets page
        var chat_input = document.getElementById('chat_input');
        
        chat_input.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                sendMsg();
            }
        });
    
        
    
        // function to log chat
        function logChat(sender, chatText) {
            let timestamp = (Date.now() - timeBase) / 1000;
            
            // create dictionary for current message info
            var currentMsg = {
                sender: sender,
                text: chatText,
                timestamp: timestamp
            };
    
            // append chatLogData
            chatLogData.push(currentMsg);
    
            // write chatLog to input field
            document.getElementById('id_chatLog').value = JSON.stringify(chatLogData);
    
        }
        
        // function to append text in webpage
        function sendMsg() {
            var text = chat_input.value.trim();
            if (text) {
                liveSend({'text': text});
                let msgSpan = document.createElement('span');
                msgSpan.textContent = text;
                let row = `<div class="msg selfText">${msgSpan.innerHTML}</div><br>`;
                chat_messages.insertAdjacentHTML('beforeend', row);    
                
                // scroll messages to bottom
                chat_messages.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'start' })
    
                // append chat log
                logChat('Participant', text)
                
            }
            chat_input.value = '';
            
        }
    
        // specify messages element
        var chat_messages = document.getElementById('chat_messages');
    
        // function for live receiving from server
        function liveRecv(data) {
            let msgSpan = document.createElement('span');
            msgSpan.textContent = data;
            let row = `<div class="msg botText">${msgSpan.innerHTML}</div><br>`;
            chat_messages.insertAdjacentHTML('beforeend', row);  
            
            // scroll messages to bottom
            chat_messages.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'start' })
            
            // append chat log
            logChat('Bot', data)
        };
    
        document.addEventListener("DOMContentLoaded", function (event) {
            liveSend({});
        });
    
    </script>

{{ endblock }}


{{ block content }}

    <!-- oTree timer -->
    <p align="center">
        Page will auto-advance in:
        <span style="color:red; font-weight: bold">
            <span class="otree-timer__time-left"></span>
        </span>
        <br>
    <button class="btn btn-primary btn-large">
        Next Page
    </button>
    
    </p>
    
    <!-- div displaying chat messages -->
    <div class="textBox">
        <div id="chat_messages">
        </div>
    </div>
    
    <!-- text input -->
    <div class="inputBox">
        <div class="typeInputBox">
            <input type="text" id="chat_input" style="text-align:right;" autofocus>
            <button type="button" onclick="sendMsg()">Send</button>
        </div>
    </div>
    
    <!-- hidden input to save chat log -->
    <input type='hidden' name='chatLog' value='' id='id_chatLog'/>
        
{{ endblock }}




